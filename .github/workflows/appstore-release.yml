name: AppStore Release

# NOTE: Test vals
on:
    push:
      branches:
        - main
    pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


jobs:
    publish-to-appstore:
        runs-on: macos-latest
        env:
            APPNAME: Serpeo
        steps:
            - uses: actions/checkout@v4
            - name: install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                targets: 'aarch64-apple-darwin,x86_64-apple-darwin'
            
            - uses: ./.github/actions/ci-setup

            - uses: Swatinem/rust-cache@v2

            - name: Setup AppStore Connect API KEY
              run: |
                mkdir -p ~/private_keys
                echo -n ${{ secrets.APPLE_KEY_CONTENT }} > ~/private_keys/AuthKey_${{ secrets.APPLE_KEY_ID }}.p8
            - name: Add Rust target for iOS
              run: |
                rustup target add aarch64-apple-ios
            - name: Build iOS App
              env:
                APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE_DIST }}
                APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD_DIST }}
                APPLE_API_ISSUER: ${{ secrets.APPLE_ISSUER_ID }}
                APPLE_API_KEY: ${{ secrets.APPLE_KEY_ID }}
                APPLE_API_KEY_PATH: ~/private_keys/AuthKey_${{ secrets.APPLE_KEY_ID }}.p8
                CI: true
              run: |
                pnpm tauri ios build --export-method app-store-connect

            - name: Upload iOS App to AppStore Connect
              working-directory: apps/serpeo
              env:
                APPLE_API_ISSUER: ${{ secrets.APPLE_ISSUER_ID }}
                APPLE_API_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
              run: |
                xcrun altool --upload-app --type ios --file "src-tauri/gen/apple/build/arm64/Serpeo.ipa" --apiKey $APPLE_API_KEY_ID --apiIssuer $APPLE_API_ISSUER
                echo "App uploaded to AppStore Connect."

            - name: Build macOS App
              run: |
                pnpm tauri build --bundles app --target universal-apple-darwin
                echo "macOS App built."

            - name: Upload macOS App to AppStore Connect
              run: |
                xcrun productbuild --sign "$CERT_ID" --component "target/universal-apple-darwin/release/bundle/macos/$APPNAME.app" /Applications "$APPNAME.pkg"
                xcrun altool --upload-app --type macos --file "$APPNAME.pkg" --apiKey $APPLE_API_KEY_ID --apiIssuer $APPLE_API_ISSUER
                echo "macOS App uploaded to AppStore Connect."
            